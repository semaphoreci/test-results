version: v1.0
name: Build
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:
  - name: Unit tests
    dependencies: []
    task:
      prologue:
        commands:
          - sem-version go 1.18
          - "export GOPATH=~/go"
          - "export PATH=/home/semaphore/go/bin:$PATH"
          - checkout
          - go get ./...
          - go get -u gotest.tools/gotestsum

      jobs:
        - name: 🧪 Go tests
          commands:
            - export SUITE_NAME="🧪 Go tests"
            - gotestsum --junitfile junit.xml

      epilogue:
        always:
          commands:
            - test-results publish --name "$SUITE_NAME" junit.xml

  - name: Security checks
    dependencies: []
    task:
      secrets:
        - name: security-toolbox-shared-read-access

      prologue:
        commands:
          - checkout
          - mv ~/.ssh/security-toolbox ~/.ssh/id_rsa
          - sudo chmod 600 ~/.ssh/id_rsa

      jobs:
        - name: 🛡️ Check dependencies
          commands:
            - export SUITE_NAME="🛡️ Check dependencies"
            - make check.deps

        - name: 🛡️ Check code
          commands:
            - export SUITE_NAME="🛡️ Check code"
            - make check.static

      epilogue:
        always:
          commands:
            - "[[ -f results.xml ]] && test-results publish --name \"$SUITE_NAME\" results.xml"

  - name: Build
    dependencies: ["Security checks", "Unit tests"]
    task:
      prologue:
        commands:
<<<<<<< HEAD
          - sem-version go 1.17
=======
          - sem-version go 1.18
>>>>>>> 907db39... feat: upgrade to golang 1.18, update dependencies
          - "export GOPATH=~/go"
          - "export PATH=/home/semaphore/go/bin:$PATH"
          - checkout
      jobs:
        - name: 🏗️ Build binary
          commands:
            - make build
            - artifact push workflow bin/test-results -d bin/test-results

after_pipeline:
  task:
    jobs:
      - name: Submit Reports
        commands:
          - test-results gen-pipeline-report


promotions:
  - name: Integration tests
    pipeline_file: integration.yml
    auto_promote:
      when: "result = 'passed'"
